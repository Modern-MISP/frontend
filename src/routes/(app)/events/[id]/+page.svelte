<script lang="ts">
  import { page } from '$app/stores';
  import Card from '$lib/components/card/Card.svelte';
  import CardHeading from '$lib/components/card/CardHeading.svelte';
  import AddTagForm from '$lib/components/tagForms/AddTagForm.svelte';
  import type { PickerPill } from '$lib/models/Picker.interface';
  import CreateTag from '../../tags/CreateTag.svelte';
  import type { PageData } from './$types';
  import EventInfo from './_components/EventInfo.svelte';
  import type { EventState } from './_components/EventState.interface';
  import EventTags from '$lib/components/pills/pillCollection/TagCollection.svelte';
  import { addTags, deleteTags } from './_components/event.util';

  /**
   * Page data containing the data of the event with the id in the url
   */
  export let data: PageData;

  let state: EventState;

  /**
   * The currently selected pills
   */
  let selection: PickerPill<{ local_only: boolean; relation: string }>[] = [];
</script>

<!-- 
  @component
  This Page will display the event with a {@link DynCard} component. The header will be generated by the formHeaders depending on the mode. 

  The Galaxies and Tags will be displayed with a {@link PillCollection}.
  The EventGraph will be displayed with the {@link EventGraph} component.
  The Attributes are basically a {@link DynTable}

  The update of the event will be handled by a form inside of this page, that is a wrapper around some DynCards. Therefore the "name" from from any inputted component will be used to calculate the final object we will send to the server. 
 -->

<EventInfo {data} bind:state>
  <svelte:fragment slot="add">
    <AddTagForm
      bind:selection
      on:createTag={() => (state = 'create')}
      on:close={() => (state = 'info')}
    />
  </svelte:fragment>

  <svelte:fragment slot="create">
    <Card>
      <CardHeading>Create a Tag</CardHeading>
      <CreateTag on:close={() => (state = 'add')}></CreateTag>
    </Card>
  </svelte:fragment>
  <Card>
    <CardHeading>Tags</CardHeading>
    <EventTags
      on:close={() => (state = 'info')}
      on:open={() => (state = 'add')}
      on:save={({ detail }) => {
        // @ts-expect-error svelte error. Does not detect the generic correctly.
        addTags(detail.map((x) => ({ ...x, eventId: $page.params.id })));
      }}
      on:delete={({ detail }) =>
        deleteTags(detail.map((x) => ({ eventId: $page.params.id, id: x.value ?? '' })))}
      tags={data.event.Tag ?? []}
      bind:selection
    />
  </Card>
</EventInfo>
