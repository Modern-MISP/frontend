<script lang="ts">
  import { api } from '$lib/api';
  import type { components } from '$lib/api/misp';
  import DynCard from '$lib/components/card/dynCard/DynCard.svelte';
  import Form from '$lib/components/form/Form.svelte';
  import AddTagForm from '$lib/components/tagForms/AddTagForm.svelte';
  import CreateTagForm from '$lib/components/tagForms/CreateTagForm.svelte';
  import type { PickerPill } from '$lib/models/Picker.interface';
  import { notifications } from '$lib/stores';
  import { successPill } from '$lib/util/pill.util';
  import type { PageData } from './$types';
  import EventTags from './EventTags.svelte';
  import { header } from './formHeaders';

  /**
   * Page data containing the data of the event with the id in the url
   */
  export let data: PageData;

  let state: 'addTag' | 'info' | 'createTag' = 'info';

  /**
   * The currently selected pills
   */
  let selection: PickerPill[] = [];

  async function formCallback(formData: Record<string, string>) {
    $api
      .PUT('/events/edit/{eventId}', {
        params: { path: { eventId: data!.event.id! } },
        body: formData as components['requestBodies']['EditEventRequest']['content']['application/json']
      })
      .then(() => notifications.add(successPill('Event updated successfully!')));
  }
</script>

<!-- 
  @component
  This Page will display the event with a {@link DynCard} component. The header will be generated by the formHeaders depending on the mode. 

  The Galaxies and Tags will be displayed with a {@link PillCollection}.
  The EventGraph will be displayed with the {@link EventGraph} component.
  The Attributes are basically a {@link DynTable}

  The update of the event will be handled by a form inside of this page, that is a wrapper around some DynCards. Therefore the "name" from from any inputted component will be used to calculate the final object we will send to the server. 
 -->

<div class="h-full overflow-auto">
  <Form callback={formCallback}>
    <div class="grid h-full grid-cols-2 gap-2 lg:flex-nowrap">
      {#if state === 'addTag'}
        <AddTagForm
          bind:selection
          on:createTag={() => (state = 'createTag')}
          on:close={() => (state = 'info')}
        />
      {:else if state === 'createTag'}
        <CreateTagForm on:close={() => (state = 'addTag')}></CreateTagForm>
      {:else}
        <section class="h-full">
          <DynCard data={data.event} {header} />
        </section>
      {/if}
      <section class="h-full">
        <EventTags bind:state {data} bind:selection />
      </section>
    </div>
  </Form>
</div>
