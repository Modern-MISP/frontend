stages:
    - uml

default:
    tags:
        - docker # I think this tag is required to make the CI runner accept the jobs

generate-uml:
    stage: uml
    image: node:latest
    script:
        - apt update
        - apt install -y plantuml
        - git remote set-url origin https://gitlab-ci-token:${PUSH_TOKEN}@gitlab.kit.edu/kit/kit-cert/mmisp/frontend.git
        - git checkout ${CI_COMMIT_BRANCH}
        - git pull
        - npm install
        - echo @feathecutie:registry=https://gitlab.com/api/v4/projects/52994631/packages/npm/ >> .npmrc
        - npx @feathecutie/svelte-to-uml@latest . ./uml.plantuml
        - plantuml -tsvg uml.plantuml
        - mkdir -p docs
        - mv uml.svg docs/
        - git add docs/
        - git config user.name uml-pipeline
        - git config user.email feathecutie@disroot.org
        - git commit -m "Auto-generated UML for '${CI_COMMIT_TITLE}'"
        - git push -o ci.skip

